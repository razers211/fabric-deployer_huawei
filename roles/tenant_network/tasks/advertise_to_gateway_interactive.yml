---
- name: Advertise tenant networks to gateway
  huawei.vrrp.vrrp_config:
    lines:
      - "bgp {{ device_asn | default(asn) }}"
      - "ipv4-family vpn-instance {{ vrf_name }}"
      - "import-route direct"
      - "import-route static"
      - "advertise l2vpn evpn"
  when: 
    - gateway_announcement | default(false)
    - device_asn is defined or asn is defined

- name: Configure route redistribution for tenant VRF
  huawei.vrrp.vrrp_config:
    lines:
      - "bgp {{ device_asn | default(asn) }}"
      - "ipv4-family vpn-instance {{ vrf_name }}"
      - "peer {{ item }} enable"
      - "peer {{ item }} advertise irb"
  loop: "{{ groups.dc_gateway | default([]) }}"
  when: 
    - gateway_announcement | default(false)
    - groups.dc_gateway is defined

- name: Verify route advertisements
  huawei.vrrp.vrrp_command:
    commands: "display bgp vpnv4 vpn-instance {{ vrf_name }} routing-table"
  register: route_advertisement

- name: Display advertisement verification
  debug:
    msg: "Tenant networks advertised to gateway successfully for {{ vrf_name }}"
  when: "'Total routes' in route_advertisement.stdout"
