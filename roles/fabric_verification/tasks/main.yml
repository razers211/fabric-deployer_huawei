---
- name: Verify BGP neighbors
  huawei.vrp.vrp_command:
    commands: "display bgp peer"
  register: bgp_peer_status
  failed_when: "'Established' not in bgp_peer_status.stdout"

- name: Verify interface status
  huawei.vrp.vrp_command:
    commands: "display interface brief"
  register: interface_status
  failed_when: "'down' in interface_status.stdout"

- name: Verify VXLAN tunnels (leaf switches)
  huawei.vrp.vrp_command:
    commands: "display vxlan tunnel"
  register: vxlan_status
  when: role == 'leaf'

- name: Verify VTEP reachability
  huawei.vrp.vrp_command:
    commands: "ping {{ hostvars[item].vtep_ip | default(hostvars[item].ansible_host) }}"
  loop: "{{ groups.spine if role == 'leaf' else groups.leaf }}"
  register: vtep_ping
  failed_when: "'success' not in vtep_ping.stdout"
  when: role == 'leaf'

- name: Display verification results
  debug:
    msg: "Fabric verification completed successfully for {{ inventory_hostname }}"
