---
- name: Backup Network Configuration
  hosts: spine, leaf, dc_gateway
  gather_facts: no
  serial: 1
  vars:
    ansible_network_os: huawei.vrp
    backup_dir: "{{ backup_path | default('/tmp/ansible_backups') }}"
    timestamp: "{{ ansible_date_time.epoch }}"

  tasks:
    - name: Create backup directory
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true

    - name: Get current configuration
      huawei.vrp.vrp_command:
        commands: "display current-configuration"
      register: device_config

    - name: Save configuration to file
      copy:
        content: "{{ device_config.stdout }}"
        dest: "{{ backup_dir }}/{{ inventory_hostname }}_{{ timestamp }}.cfg"
        mode: '0644'
      delegate_to: localhost

    - name: Display backup completion
      debug:
        msg: "Configuration backed up for {{ inventory_hostname }} to {{ backup_dir }}/{{ inventory_hostname }}_{{ timestamp }}.cfg"
