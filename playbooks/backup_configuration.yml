---
- name: Backup Network Configuration
  hosts: spine, leaf, dc_gateway
  gather_facts: no
  serial: 1
  vars:
    ansible_network_os: ce
    ansible_connection: ssh
    backup_dir: "{{ backup_path | default('/tmp/ansible_backups') }}"
    timestamp: "{{ ansible_date_time.epoch }}"

  tasks:
    - name: Create backup directory
      local_action:
        module: file
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'
      run_once: true

    - name: Get current configuration
      raw: "display current-configuration"
      register: device_config

    - name: Save configuration to file
      local_action:
        module: copy
        content: "{{ device_config.stdout }}"
        dest: "{{ backup_dir }}/{{ inventory_hostname }}_{{ timestamp }}.cfg"
        mode: '0644'

    - name: Display backup completion
      debug:
        msg: "Configuration backed up for {{ inventory_hostname }} to {{ backup_dir }}/{{ inventory_hostname }}_{{ timestamp }}.cfg"
