---
- name: Verify Spine-Leaf Fabric
  hosts: spine, leaf
  gather_facts: no
  serial: 1
  vars:
    ansible_network_os: ce
    ansible_connection: network_cli
  
  tasks:
    - name: Check BGP neighbor status
      ansible.netcommon.cli_command:
        commands: "display bgp peer"
      register: bgp_peers
      failed_when: "'Established' not in bgp_peers.stdout"

    - name: Check interface status
      ansible.netcommon.cli_command:
        commands: "display interface brief"
      register: interfaces
      failed_when: "'down' in interfaces.stdout"

    - name: Check VXLAN tunnel status
      ansible.netcommon.cli_command:
        commands: "display vxlan tunnel"
      register: vxlan_tunnels
      when: role == 'leaf'

    - name: Verify VTEP reachability
      ansible.netcommon.cli_command:
        commands: "ping {{ hostvars[item].vtep_ip }}"
      loop: "{{ groups.spine if role == 'leaf' else groups.leaf }}"
      register: vtep_ping
      failed_when: "'success' not in vtep_ping.stdout"
      when: 
        - role == 'leaf'
        - hostvars[item].vtep_ip is defined

    - name: Display verification results
      debug:
        msg: "Fabric verification completed successfully for {{ inventory_hostname }}"

- name: Verify DC Gateway Connectivity
  hosts: dc_gateway
  gather_facts: no
  vars:
    ansible_network_os: ce
    ansible_connection: network_cli
  
  tasks:
    - name: Check BGP routes from fabric
      ansible.netcommon.cli_command:
        commands: "display bgp routing-table"
      register: bgp_routes

    - name: Verify external connectivity
      ansible.netcommon.cli_command:
        commands: "ping 8.8.8.8"
      register: external_ping
      failed_when: "'success' not in external_ping.stdout"

    - name: Display gateway verification results
      debug:
        msg: "Gateway verification completed successfully"
